<!DOCTYPE html>
<html lang="en"
      xmlns:="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head th:include="admin/layout :: header">
    
    <style>
        .pointer {cursor: pointer;}
    </style>
</head>
<body>
	<title>Input Data / Problem Identification form & follow up</title>
    <div th:include="admin/layout :: menu"></div>    
    <div id="content">
        <div id="content-header">
            <div id="breadcrumb" class="lang_eng" style="display: none"> <a href="#" title="Go to Home" class="tip-bottom"><i class="icon-home"></i>Input Data / Problem Identification form & follow up </a></div>
            <div id="breadcrumb" class="lang_indo"> <a href="#" title="Ke Home" class="tip-bottom"><i class="icon-home"></i>Input Data / Identifikasi Masalah dan Solusi</a></div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="widget-box" style="width: 100%;">
                    <div class="widget-title lang_eng" id="judul-eng" style="display: none">
                        <span class="icon"><i class="icon-tasks"></i></span>
                        <h5>Problem Identification form & follow up </h5>
                    </div>
                    <div class="widget-title lang_indo" id="judul-indo">
                        <span class="icon"><i class="icon-tasks"></i></span>
                        <h5>Tabel Identifikasi Masalah dan Solusi</h5>
                    </div>
                    
                   
                    <div class="widget-content">
                        <div class="pull-left" style="width:100%">
                            <select th:field="*{listprov}" class="span3" id="id_prov" name="id_prov">
                                <option value="0" >-- Pilih --</option>
                                <option th:each="list : ${listprov}" th:value="${list.id_prov}" th:text="${list.acronym}"></option>
                            </select>
                            <select id="idrole" name="idrole" class="form-control">
                                <option value="0" >-- Pilih --</option>
                                <option th:each="f:${listNsaProfile}" th:value="${f.id_role}" th:text="${f.nm_role}"></option>
                            </select>
                            
<!--                            <div class="lang_indo"><span> Periode</span></div>
                            <div class="lang_eng"><span> Period</span></div>-->
                            <select id="periode" name="periode" class="form-control">
                                <option value="0" >-- Pilih --</option>
                                <!--<option id="monper" th:each="f:${listranrad}" th:value="${f.id_monper}" th:text="${f.start_year}+' - '+${f.end_year}"></option>-->
                            </select>
                            <div class="input-append pull-right">
                                <div class="span6" align="right">
                    			<button data-toggle="modal" id="add_problem" data-target="#myModal" class="btn btn-primary hide"><i class="icon-plus"></i>
                    				<span class="lang_eng" style="display:none">Add Problem Identify</span><span class="lang_indo">Tambah Identifikasi Masalah</span>
                    			</button>
<!--                                        <a class="btn btn-success appl" id="apply_btn" data-periode="1" style=" margin-left: 10px;display: none">
                                            <span class="lang_indo">Terapkan</span>
                                            <span class="lang_eng">Apply</span>
                                        </a>
                                        <a class="btn btn-warning unappl" id="unapply_btn" data-periode="1" style="margin-left: 10px;display: none">
                                            <span class="lang_indo">Batal Terapkan</span>
                                            <span class="lang_eng">UnApply</span>
                                        </a>-->
                    		</div>
                            </div>
<!--                            <div class="btn-toolbar lang_eng" style="float:right; display: none" id="btn_eng">
                                <button class="btn btn-warning btn-small tambah">
                                    Add New
                                </button>
                                <button class="btn btn-success btn-small">Import</button>
                                <button class="btn btn-primary btn-small">Export</button>
                            </div>
                            <div class="btn-toolbar lang_indo" style="float:right" id="btn_indo">
                                <button class="btn btn-warning btn-small tambah">
                                    Tambah Baru
                                </button>
                                <button class="btn btn-success btn-small">Impor</button>
                                <button class="btn btn-primary btn-small">Ekspor</button>
                            </div>-->
                        </div>
                        <div class="row-fluid">
                           <div class="span12">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="tabel-goals" style="width:100%">
                                    <thead><tr>
	                                            <th style="text-align:center;font-size:80%;" >
	                                                <span class="lang_eng" style="display:none">Code</span>
	                                                <span class="lang_indo">Kode</span>
	                                            </th>
	                                            <th style="text-align:center;font-size:80%;" >
	                                                <span class="lang_eng" style="display:none">Sdgs Indicator</span>
	                                                <span class="lang_indo">Sdg Indicator</span>
	                                            </th>
	                                            <th style="text-align:center;font-size:80%;">
	                                                <span class="lang_eng" style="display:none">Category</span>
	                                                <span class="lang_indo">Kategory</span>
	                                            </th>
	                                            <th style="text-align:center;font-size:80%;" >
	                                                <span class="lang_eng" style="display:none">Problem Identify</span>
	                                                <span class="lang_indo">Identifikasi Masalah</span>
	                                            </th>
	                                            <th style="text-align:center;font-size:80%;" >
	                                                <span class="lang_eng" style="display:none">Follow Up</span>
	                                                <span class="lang_indo">Solusi</span>
	                                            </th>
	                                            <th style="text-align:center;font-size:80%;" >
	                                                <span class="lang_eng" style="display:none">Action</span>
	                                                <span class="lang_indo">Aksi</span>
	                                            </th>
	                                        </tr>
                                    </thead>
<!--                                    <tbody id="tbody-goals">
                                    </tbody>-->
                                </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="myModal"data-backdrop="static" class="modal hide fade modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width:1000px!important;left:35%!important">
			<div class="modal-header">
			    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
			    <h3 class="lang_eng" style="display:none">Add Disaggregation</h3>
			    <h3 class="lang_indo">Tambah Disaggregation</h3>
		  	</div>
			<div class="modal-body">
				<form>
                                    <input type="hidden" id="id" name="id"/>
                                    <input type="hidden" id="id_relation" name="id_relation"/>
                                    <div class="control-group">
				    <label class="lang_eng" style="display:none">Ref Category</label>
				    <label class="lang_indo">Ref Category</label>
                                    <select id="ref_category" name="ref_category" class="form-control">
                                        <option value="0" >-- Pilih Category --</option>
                                        <option th:each="f:${refcategory.content}" th:value="${f.id_cat}" th:text="${f.nm_cat}"></option>
                                    </select>
                                    </div>
                                    <div class="control-group">
                                    <div class="accordion" id="accordion2">
                                        <div class="accordion-group">
                                            <div class="accordion-heading">
                                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                                                    <label class="lang_eng control-label" style="display:none">Select SDGs Indicator</label>
                                                    <label class="lang_indo control-label">Pilih Indikator SDG</label>
                                                </a>
                                            </div>
                                            <div id="collapseOne" class="accordion-body collapse">
                                                <div class="accordion-inner">
                                                    <div id="filter_sdg">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="control-group">
                                        <label th:class="control-label" for="detail">Problem</label>
                                        <div class="controls">
                                            <textarea class="input-block-level" id="problem" name="problem" rows="3"></textarea>
                                        </div>
                                    </div>
                                    <div class="control-group">
                                        <label th:class="control-label" for="detail">Follow Up</label>
                                        <div class="controls">
                                            <textarea class="input-block-level" id="follow_up" name="follow_up" rows="3"></textarea>                                            
                                        </div>
                                    </div>
				</form>
			</div>
			<div class="modal-footer">
		    	<button class="btn" data-dismiss="modal" aria-hidden="true">
		    		<span class="lang_eng" style="display:none">Close</span>
		    		<span class="lang_indo">Tutup</span>
		    	</button>
		    	<button class="btn btn-primary" id="submit">
		    		<span class="lang_eng" style="display:none">Submit</span>
		    		<span class="lang_indo">Simpan</span>
		    	</button>
		  	</div>
		</div>
    </div>
    
    <script th:inline="javascript">
        
        var token       = $("meta[name='_csrf']").attr("content");
	var header      = $("meta[name='_csrf_header']").attr("content");
        var id_role     = [[${id_role}]];
        console.log(id_role);
        var id_prov     = [[${id_prov}]];
        var privilege   = [[${privilege}]];
        var filtersdg   = [[${filtersdg}]];
        var lisdg2       = [];
        $2.each(filtersdg.data,function(i,x){
            var obj2 = {'id':x[0],'parent':x[5],'text':x[4]+' '+x[1],'a_attr':{'level':x[3],'id_parent':x[0]},'state' : {'opened' : true} }
            lisdg2.push(obj2);
        });
        
        $2('#filter_sdg').jstree({ 
                    'core'   : {
                        'data' : lisdg2,
                        'check_callback': false,
                        "themes" : {
                                    "variant" : "small",
                                    "dots" : false,
                                    "icons":false
                                  }
                    },"checkbox" : {
                        "three_state"   : false,
                        "whole_node"    : false,  // to avoid checking the box just clicking the node 
                        "tie_selection" : false //
                      },
                    "plugins" : [ "checkbox" ] 
                }).on("check_node.jstree", function(e, data) {
//                    console.log(data.node.id + ' ' + data.node.text + ' level '+data.node.level +
//                          (data.node.state.checked ? ' CHECKED': ' NOT CHECKED'));
                    var level = data.node.a_attr.level;
//                    console.log(data);
                    if(level==1){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.children_d)
                    }
                     if(level==2){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.parent)
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.children_d)
                    }
                     if(level==3){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.parents)
                    }
//                    console.log($2('#filter_sdg').jstree(true).get_checked());
                  });
        function tree(id,data,node_data){
            $2('#sdg_data'+id).jstree({ 
                    'core'   : {
                        'data' : data,
                        'check_callback': false,
                        "themes" : {
                                    "variant" : "small",
                                    "dots" : false,
                                    "icons":false
                                  }
                    },"checkbox" : {
                        "three_state"   : false,
                        "whole_node"    : false,  // to avoid checking the box just clicking the node 
                        "tie_selection" : false //
                      },
                    "plugins" : [ "checkbox" ] 
                }).on("load_node.jstree", function(e, data) {
                    $2('#sdg_data'+id).jstree(true).check_node(node_data);
                    $2('#sdg_data'+id).jstree(true).disable_checkbox(data.node.children_d);
//                    console.log(data);
                  });
        }
        if(privilege == 'SUPER'){

        }else{
            $.ajax({
                type: "GET",
                url: urls+'list-get-option-role-all-profil-notojk/'+id_prov,
                success: function (result) {
                    $("#idrole").html('<option value="0" >-- Pilih --</option>');
                    var array = result.content;
                    if (array != '') {
                        for (i in array) {
                            $("#idrole").append('<option value="'+array[i][0]+'" >'+array[i][1]+'</option>');
                        }
                    }
                    if(privilege == 'ADMIN'){
                        $("#idrole").val('0').trigger("change").attr('disabled',false);
                    }else{
                        $("#idrole").val(id_role).trigger("change").attr('disabled',true);
                    }
                }
            });

            $.ajax({
                type: "GET",
                url: urls+'list-get-option-monper/'+id_prov,
                success: function (result1) {
                    $("#periode").html('<option value="0" >-- Pilih --</option>');
                    var array1 = result1.content;
                    if (array1 != '') {
                        for (i in array1) {
                            var selisih     = (array1[i][2] - array1[i][1]);
//                                console.log(array1[i][2]);
                            var x;
                            for(x=0; x<=selisih; x++){
//                                    console.log((array1[i][1]+x));
                                $("#periode").append('<option value="'+array1[i][0]+'###'+(array1[i][1]+x)+'" >'+(array1[i][1]+x)+'</option>');
                            }

                        }
                    }

                }
            });

            $("#id_prov").val(id_prov).trigger("change").attr('disabled',true);



        }


        $("#id_prov").on('change', function(e){
            var id_prov = this.value ;
            $.ajax({
                type: "GET",
                url: urls+'list-get-option-role-all-profil-notojk/'+id_prov,
                success: function (result) {
                    $("#idrole").html('<option value="0" >-- Pilih --</option>');
                    var array = result.content;
                    if (array != '') {
                        for (i in array) {
                            $("#idrole").append('<option value="'+array[i][0]+'" >'+array[i][1]+'</option>');
                        }
                    }
                    grid();
                }
            });

            $.ajax({
                type: "GET",
                url: urls+'list-get-option-monper/'+id_prov,
                success: function (result1) {
                    $("#periode").html('<option value="0" >-- Pilih --</option>');
                    var array1 = result1.content;
                    if (array1 != '') {
                        for (i in array1) {
                            var selisih     = (array1[i][2] - array1[i][1]);
//                                console.log(array1[i][2]);
                            var x;
                            for(x=0; x<=selisih; x++){
//                                    console.log((array1[i][1]+x));
                                $("#periode").append('<option value="'+array1[i][0]+'###'+(array1[i][1]+x)+'" >'+(array1[i][1]+x)+'</option>');
                            }

                        }
                    }
                }
            });
        });

        $("#periode").on('change', function(e){
            var data_id     = this.value.split("###");;
            var id_monper   = data_id[0];
            var tahun       = data_id[1];
            grid();
            grid_problem();
//             table.columns.adjust();
//             grid_problem();
           // $('#add_problem').show();
        });

        $("#idrole").on('change', function(e){
            var data_id     = this.value.split("###");;
            var id_monper   = data_id[0];
            var tahun       = data_id[1];
            grid();
        });


        $('#teruskan').on('click', '#apply_btn', function(e){
            alert('button is not a function');
        });


        //tutup validasi role

        //Bahasa
        var titleDel = "Anda Yakin";
            var messDel = "Menghapus Data?";
            var buttDel = 'Ya, Hapus data ini!';
            var titleOk	= "Hapus";
            var messOk = "Data berhasil dihapus";
            var messNOk = "Data tidak dapat dihapus";
            var required = "Harus diisi";
            function bhs(cek){
                            if(cek){
                                    $(".lang_indo").show();
                            $(".lang_eng").hide();
                            titleDel = "Anda Yakin";
                            messDel = "Menghapus Data?";
                            buttDel = 'Ya, Hapus data ini!';
                            titleOk	= "Hapus";
                    messOk = "Data berhasil dihapus";
                    messNOk = "Data tidak dapat dihapus";
                    required = "Harus diisi";
                    }else{	    	        
                    $(".lang_indo").hide();
                            $(".lang_eng").show();
                            titleDel = "Are you sure";
                            messDel = "Delete this data?";
                            buttDel = 'Yes, Delete this data!';
                            titleOk	= "Delete";
                    messOk = "Delete successful";
                    messNOk = "Can't delete data";
                    required = "Required";
                    }
            }
            if(lang){
                    bhs(lang=="0");
            }else{
                    bhs($('#fs').is(':checked'));
            }

            $('#fs').on('change', function(e){
                grid();
                    bhs($(this).is(':checked'));
            });
            
            var table;
            function grid_problem(){
                var t;
                var v_idrole    = $("#idrole").val();
                var v_dataid    = $("#periode").val();
                var v_data_id   = v_dataid.split("###");
                var id_monper   = v_data_id[0];
                var tahun       = v_data_id[1];
                var cek1;
                $.ajax({
                    type: "GET",
                    async:false,
                    url: urls+'cek-show-report/'+id_monper+'/'+tahun+'/entry_problem_identify',
                    success: function (result1) {
                            cek1 = result1.cek[0][0];
                    }
                });
                console.log("cek ya "+cek1);
                var header = '';
                header += '<tr class="" > <th style="text-align:center;font-size:80%;" ><span class="lang_eng" style="display:none">Code</span><span class="lang_indo">Kode</span></th> <th style="text-align:center;font-size:80%;" ><span class="lang_eng" style="display:none">Sdgs Indicator</span><span class="lang_indo">Sdg Indicator</span></th> <th style="text-align:center;font-size:80%;"><span class="lang_eng" style="display:none">Category</span><span class="lang_indo">Kategory</span></th> \n\
                                <th style="text-align:center;font-size:80%;" ><span class="lang_eng" style="display:none">Problem Identify</span><span class="lang_indo">Identifikasi Masalah</span></th> <th style="text-align:center;font-size:80%;" ><span class="lang_eng" style="display:none">Follow Up</span><span class="lang_indo">Solusi</span></th> ';
                header +=   '<th style="text-align:center;font-size:80%;" ><span class="lang_eng" style="display:none">Action</span><span class="lang_indo">Aksi</span></th>';
                header +=   '</tr>';
                //if(t){t.clear().destroy();}
                //$('#tabel-goals thead').html(''); 
                //$('#tabel-goals thead').html(header);
                table = $('#tabel-goals').DataTable(
                        {
            ////				sDom: 'lrtip',
            //				"bLengthChange": false,
            //				"cache": false,
            ////                                "scrollX": true,
            //				"autoWidth": false,
            //				"responsive":false,
            //                                 paging:    true,

                                            responsive: true,
                                            sDom: 'lrtip',
                                            "bLengthChange": false,
                                            "cache": false,
                                            "autoWidth": true,
                                            "responsive":true,
                                            "bDestroy": true,
                                            "paging": false,
                                            "ordering": false,

                                            "drawCallback": function( settings ) {
                                                var cektabel = $('#tabel-goals > tbody').find('.dataTables_empty').length;
                                                console.log("cektabel = "+cektabel)
                                                if(cektabel==0){
                                                    console.log("masuk 1 = "+cektabel);
                                                    var tabel = $('#tabel-goals > tbody').find('tr:last');
                                                    var btnApply1=(cek1>0)?'':'<a title="Apply" class="btn btn-success appl" id="apply_btn" data-periode="1" href="#"><i class="icon-upload "></i>Apply</a></td>';
//                                                    var btnApply1=(cek1>0)?'':'<a class="btn btn-success appl" id="apply_btn" data-periode="1" style=" margin-left: 10px;display: none"><span class="lang_indo">Terapkan</span><span class="lang_eng">Apply</span></a></td>';
                                                    $.ajax({
                                                        type: "GET",
                                                        url: urls+'get-approve/entry_problem_identify/'+tahun+'/'+id_monper+'/0'+'/'+v_idrole,
                                                        async:false,
                                                        success: function (result) {
                                                            apply = result.content;
                                                            if(apply.length>0){
                                                                    if(apply[0][1]=="1"){
                                                                        console.log("ke 1");
                                                                        btnApply1='<a title="Apply" class="btn btn-warning unappl" id="unapply_btn" data-periode="1" href="#"><i class="icon-upload "></i>UnApply</a></td>';
//                                                                        btnApply1='<a class="btn btn-warning unappl" id="unapply_btn" data-periode="1" style="margin-left: 10px;display: none"><span class="lang_indo">Batal Terapkan</span><span class="lang_eng">UnApply</span></a>';
                                                                    }else if(apply[0][1]=="2"){
                                                                        console.log("ke 2");
                                                                        if($("#fs").is(':checked')){
                                                                            btnApply1 = "<span class='label label-success'>Disetujui</span>";
                                                                        }else{
                                                                            btnApply1 = "<span class='label label-success'>Approved</span>";
                                                                        }
                                                                    }else if(apply[0][1]=="4"){
                                                                        console.log("ke 4");
                                                                        if($("#fs").is(':checked')){
                                                                            btnApply1 = "<span class='label label-info'>Tampil Laporan</span>";
                                                                        }else{
                                                                            btnApply1 = "<span class='label label-info'>Show Report</span>";
                                                                        }
                                                                    }else if(apply[0][1]=="3"){
                                                                        console.log("ke 3");
                                                                        var label;
                                                                        if($("#fs").is(':checked')){
                                                                            label = "<span class='label label-important'>Ditolak</span>";
                                                                        }else{
                                                                            label = "<span class='label label-important'>Rejected</span>";
                                                                        }
                                                                        if(cek1>0){
                                                                            btnApply1=label;
                                                                        }else{
                                                                            btnApply1=label+'<br/><br/><a title="Apply" class="btn btn-warning unappl" id="unapply_btn" data-periode="1" href="#"><i class="icon-upload "></i>UnApply</a></td>';	
                                                                        }

                                                                    }else if(apply[0][1]=="5"){
                                                                        console.log("ke 5");
                                                                        var label;
                                                                        if($("#fs").is(':checked')){
                                                                            label = "<span class='label label-default'>Tidak ada aksi</span>";
                                                                        }else{
                                                                            label = "<span class='label label-important'>No Action</span>";
                                                                        }
                                                                        if(cek1>0){
                                                                            btnApply1=label;
                                                                        }else{
                                                                            btnApply1=label+'<br/><br/><a data-id="0###'+v_idrole+'###'+id_monper+'###'+tahun+'###1###entry_sdg###1" title="Unapply" class="btn btn-danger unapply" href="#"><i class="icon-upload "></i>Unapply</a>';	
                                                                        }

                                                                    }else{
                                                                        console.log("ke lain");
                                                                        btnApply1 = '<a class="btn btn-success appl" id="apply_btn" data-periode="1" style=" margin-left: 10px;display: none"><span class="lang_indo">Terapkan</span><span class="lang_eng">Apply</span></a>';
                                                                    }
                                                            }else{
                                                                console.log("ke lain luar");
//                                                                btnApply1 = 'lala loo';
//                                                                btnApply1 = '<a class="btn btn-success appl" id="apply_btn" data-periode="1" style=" margin-left: 10px;display: none"><span class="lang_indo">Terapkan</span><span class="lang_eng">Apply</span></a>';
                                                            }
                                                        },
                                                    });

                                                    tabel.after(
                                                                    '<tr>'+
                                                                            '<td></td>'+
                                                                            '<td></td>'+
                                                                            '<td></td>'+
                                                                            '<td></td>'+
                                                                            '<td></td>'+
                                                                            '<td>'+btnApply1+'</td>'+
                                                                    '</tr>'
                                                                    ); 
                                                }
                                            },


                                            "ajax": {
                                                    "url": urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole,
                                                    dataSrc: 'content',
                                            },
                                            "searching": false,
                                            "columns": [
                                                    {"data": function (row, data, index, display) {
                                                            var grouphtml = "";
                                                            if(row[23]!=null){
                                                                var data   = row[23].split(",");
                                                                    $.each(data,function(i,x){
                                                                        var dataid          = x.split("###");
                                                                        var lengthdataid    = dataid.length-1;
                                                                        var htmlid = "";
                                                                            $.each(dataid,function(ii,xx){
                                                                                if(ii<lengthdataid){
                                                                                   if(ii==0){ 
                                                                                        htmlid+= '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                    }
                                                                                   if(ii==1){
                                                                                       htmlid+=  '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                    }
                                                                                   if(ii==2){
                                                                                       htmlid+=  '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                    } 
                                                                                }
                                                                            });
                                                                        grouphtml +=htmlid;
                                                                    })
                                                            }

                                                            return grouphtml;
                                                            }},
                                                    {"data": function (row, data, index, display) {
                                                            var grouphtml = "";
                                                            if(row[23]!=null){
                                                                var data   = row[23].split(",");
                                                                $.each(data,function(i,x){
                                                                    var dataid          = x.split("###");
                                                                    var lengthdataid    = dataid.length-1;
                                                                    var dataur          = dataid[lengthdataid].split("##*##");
                                                                    var htmlid = "";
                                                                        $.each(dataur,function(ii,xx){
                                                                               if(ii==0){                                                               
                                                                                    htmlid+= '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                }
                                                                               if(ii==1){
                                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:20px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                }
                                                                               if(ii==2){
                                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:40px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                                } 
                                                                        });
                                                                    grouphtml +=htmlid;
                                                                })
                                                            }

                                                            return grouphtml;
                                                    }},
                                                    {"data": function (row, data, index, display) {
                                                                    return "<div style='font-size:80%;'>"+row[13]+"</div>";
                                                    }},
                                                    {"data": function (row, data, index, display) {
                                                                    return "<div style='font-size:80%;'>"+row[14]+"</div>";
                                                    }},
                                                    {"data": function (row, data, index, display) {
                                                                    return "<div style='font-size:80%;'>"+row[15]+"</div>";
                                                    }},
                                                 {"data": function (row, data, index, display) {
                                                            var data =  JSON.stringify(row).replace(/'/g, "&#39");
                                                            var id = row[16];
                                                            if(row[17]==1){
//                                                                 return '<span class="label label-success">Apply</span>';
                                                                 return '';
                                                             }else if(row[17]==2){
//                                                                 return "<span class='label label-success'>Approved</span>";
                                                                 return "";
                                                             }else if(row[17]==3){
                                                                return "";
//                                                                 return "<span class='label label-important'>Rejected</span>";
                                                             }else if(row[17]==4){
                                                                 return "";
//                                                                 return "<span class='label label-info'>Show Report</span>";
                                                             }else if(row[17]==5){
                                                                 return "";
//                                                                 return "<span class='label label-default'>No Action</span>";
                                                             }else{
                                                                 return "<div style='text-align:center;'>"+
                                                                        '<button data-id="'+id+'" type="button" title="update" class="btn btn-warning btn-mini update"><i class="icon-pencil"></i></button>'+
                                                                        '<button data-id="'+id+'" type="button" title="delete" class="btn btn-danger btn-mini delete"><i class="icon-trash"></i></button></div>'; 

                                                             }
            //							if(row[17]==1||row[17]==3){
            //                                                           /*  $('#unapply_btn').show();
            //                                                            $('#add_problem').hide();
            //                                                            $('#apply_btn').hide(); */
            //                                                            return '';
            //                                                        }else if(row[17]==2||row[17]==4){
            //                                                           /*  $('#unapply_btn').hide();
            //                                                            $('#add_problem').hide();
            //                                                            $('#apply_btn').hide(); */
            //                                                            return '';
            //                                                        }else{
            //                                                            /* $('#apply_btn').show();
            //                                                            $('#unapply_btn').hide(); 
            //                                                            $('#add_problem').show(); */
            //                                                           
            //                                                        }
                                                    }}

                                            ],
                                            columnDefs: [
//                                                { "width": "10%", "targets": 0 },
//                                                { "width": "40%", "targets": 1 },
//                                                { "width": "10%", "targets": 2 },
//                                                { "width": "15%", "targets": 3 },
//                                                { "width": "15%", "targets": 4 },
//                                                { "width": "10%", "targets": 5 },
//                                                { "width": "10%", "targets": 6 },
            //                                    {
            //                                        "targets": [ 0 ],
            //                                        "visible": false,
            //                                        "searchable": false
            //                                    },
                                            ],
            //                                fixedColumns: true,
                                            select: true
                                    }        
                        );
            }
            
            

            //memanggil tb spp
            function grid()
            {
                var v_idprov    = $("#id_prov").val();
                var v_idrole    = $("#idrole").val();
                var v_dataid    = $("#periode").val();
                var v_data_id   = v_dataid.split("###");;
                var id_monper   = v_data_id[0];
                var tahun       = v_data_id[1];
                
                
                
                
                grid_problem();
//                alert(urls+'list-problem/'+id_monper);
//                table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole ).load(function(result){
//                    /* var count_data = result.content.length;
//                    if(count_data==0){
//                        $('#apply_btn,#unapply_btn').hide();
//                        $('#add_problem').show();
//                    }else{
//                    } */
//                    
//                });
                $.ajax({
                type: "GET",
                url: urls+'get-status-approve/'+v_idrole+'/'+id_monper+'/'+tahun+'/entry_problem_identify/0',
                async:false,
                success: function (result1) {
                	$("#status").html("");
                    if(result1.content[0] == "1"){
                        $('#apply_btn').hide();
                        $('#unapply_btn').show();
                        $('#add_problem').hide();
                    }else if(result1.content[0] == "2"){
                        $('#apply_btn').hide();
                        $('#unapply_btn').hide();
                        $('#add_problem').hide();
                        $("#status").append("<span class='label label-success'>Approved</span>");
                    }else if(result1.content[0] == "3"){
                        $('#apply_btn').hide();
                        $('#unapply_btn').show();
                        $('#add_problem').hide();
                    }else if(result1.content[0] == "4"){
                        $('#apply_btn').hide();
                        $('#unapply_btn').hide();
                        $('#add_problem').hide();
                        $("#status").append("<span class='label label-info'>Show Report</span>");
                    }else if(result1.content[0] == "5"){
                        $('#apply_btn').hide();
                        $('#unapply_btn').show();
                        $('#add_problem').hide();
                    }else{
                    	if(v_idprov!="0" && v_idrole!="0" && v_dataid!="0"){
                    		$('#apply_btn').show();
                            $('#unapply_btn').hide();
                            $('#add_problem').show();
                    	}
                        $("#status").html("");
                    }
                }
            });
                
                $.ajax({
                    type: "GET",
                    async:false,
                    url: urls+'cek-show-report/'+id_monper+'/'+tahun+'/entry_problem_identify',
                    success: function (result1) {
                    	var cek = result1.cek[0][4];
                    	console.log(cek)
                    	if(cek>0){
                    		$('#apply_btn').hide();
                            $('#unapply_btn').hide(); 
                            $('#add_problem').hide();
                    	}
                    }
            	});
            }
            
            $('#text-cari').on( 'keyup', function () {
                var val=$(this).val();
                table.search(val).draw();
            });
            
//            $('#apply_btn').on('click',function(){
            $('#tabel-goals').on('click', '#apply_btn', function(){
                 var v_idprov    = $("#id_prov").val();
                 var v_idrole    = $("#idrole").val();
                 var v_dataid    = $("#periode").val();
                 var v_data_id   = v_dataid.split("###");;
                 var id_monper   = v_data_id[0];
                 var tahun       = v_data_id[1];
                            swal({
                                title: "Are You Sure",
                                text: "",
                                type: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes'
                            }).then(function () {
                               
//                                console.log(data[0][2]);
//                                return false;
                                 
                                 var data = JSON.stringify({
                                                'id_monper'     :id_monper,
                                                'tahun'         :tahun,
                                                'id_role'       :v_idrole
                                            });
                                    
                                    $.ajax({
						type: "POST",
                                                url: urls+'problem-identification/aply',
                                                beforeSend : function(xhr){
                                                    xhr.setRequestHeader(header,token);
                                                },
                                                headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                data: data,
                                                success: function (result) {
                                                    grid_problem();
                                                    $('#add_problem').hide();
//                                                             $('#apply_btn').hide();
//                                                             $('#add_problem').hide();
//                                                             $('#unapply_btn').show();
//                                                    table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole).load(function(e){
//                                                        if(e.count_data>0){
//                                                               $.each(e.content,function(i,x){
//                                                                    var node_data = x[22].split(",")
//                                                                    tree(x[21],lisdg2,node_data);
//                                                                    var id = x[21];
//                                                                    $2('#sdg_data'+id).jstree(true).check_node(node_data);
//
//                                                                })
//                                                        }
//                                                    });
                                                },
                                            });
                             }, function (dismiss) {
                                if (dismiss === 'cancel') {
                                }
                            });
                               
                        });
                        
            $('#tabel-goals').on('click', '#unapply_btn', function(){
            	var v_idprov    = $("#id_prov").val();
                var v_idrole    = $("#idrole").val();
                var v_dataid    = $("#periode").val();
                var v_data_id   = v_dataid.split("###");;
                var id_monper   = v_data_id[0];
                var tahun       = v_data_id[1];
                            swal({
                                title: "Are You Sure",
                                text: "",
                                type: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes'
                            }).then(function () {
                               
//                                console.log(data[0][2]);
//                                return false;
                                 
                                 var data = JSON.stringify({
                                                'id_monper'     :id_monper,
                                                'tahun'         :tahun,
                                                'id_role'		: v_idrole
                                            });
                                    
                                    $.ajax({
						type: "POST",
                                                url: urls+'problem-identification/un-aply',
                                                beforeSend : function(xhr){
                                                    xhr.setRequestHeader(header,token);
                                                },
                                                headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                data: data,
                                                success: function (result) {
                                                    grid_problem();
                                                    $('#add_problem').show();
//                                                             $('#apply_btn').show();
//                                                             $('#unapply_btn').hide();
//                                                             $('#add_problem').show();
//                                                    table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole	).load(function(e){
//                                                        if(e.count_data>0){
//                                                               $.each(e.content,function(i,x){
//                                                                    var node_data = x[22].split(",")
//                                                                    tree(x[21],lisdg2,node_data);
//                                                                    var id = x[21];
//                                                                    $2('#sdg_data'+id).jstree(true).check_node(node_data);
//
//                                                                })
//                                                        }
//                                                    });
                                                },
                                            });
                             }, function (dismiss) {
                                if (dismiss === 'cancel') {
                                }
                            });
             });
             
             
             $('#tabel-goals').on('click', '.update', function(){
				var id = $(this).attr('data-id');
                                var tr          = $(this).closest('tr');
                                var datatable   = table.row(tr).data();
                                var id_goals        = datatable[1];
                                var id_target       = datatable[5];
                                var id_indicator    = datatable[9];
                                var id_filter_sdg   = id_goals+"."+id_target+"."+id_indicator;
                                var check_node      = datatable[22].split(",");
                                console.log(check_node);
//                                return false;
                                var id_relation     = datatable[21];
//                                var node_data =[];
//                                $.each(check_node,function(ii,xx){
//                                    node_data.push(xx.id_sdgs);
//                                });
//                                console.log(node_data);
                                $2('#filter_sdg').jstree(true).check_node(check_node);
				$.ajax({
					type: "GET",
                                    url: urls+'problem/get-problem/'+id,
                                    success: function (result) {
                                        var val = result.content;
                                        $('#id').val(val[0].id);
                                        $('#ref_category').val(val[0].id_cat)
                                        $('#problem').val(val[0].problem)
                                        $('#filter_sdg').val(id_filter_sdg).trigger('change');
                                        $('#follow_up').val(val[0].follow_up)
                                        $('#id_relation').val(id_relation);
                                        $('#myModal').modal('show');
                                    },
                                })
             }).on('click', '.detail', function(){
                    var tr          = $(this).closest('tr');
                    var datatable   = table.row(tr).data();
                    var id_goals        = datatable[1];
                    var id_target       = datatable[5];
                    var id_indicator    = datatable[9];
                    var id_filter_sdg   = id_goals+"."+id_target+"."+id_indicator;
                    console.log(id_filter_sdg);
				var id = $(this).attr('data-id');
				$.ajax({
					type: "GET",
                                    url: urls+'problem/get-problem/'+id,
                                    success: function (result) {
                                        var val = result.content;
                                        $('#id').val(val[0].id);
                                        $('#ref_category').val(val[0].id_cat).attr("readonly",true);
                                        $('#problem').val(val[0].problem).attr("readonly",true);
                                        $('#follow_up').val(val[0].follow_up).attr("readonly",true);
                                        $('#filter_sdg').val(id_filter_sdg).trigger('change');//attr("readonly",true);
                                        $("#filter_sdg").attr("disabled",true);
                                        $('#submit').prop('disabled',true);
                                        $('#myModal').modal('show');
                                    },
                                })
             }).on('click', '.delete', function(){
                    var id          = $(this).attr('data-id');
                    var tr          = $(this).closest('tr');
                    var datatable   = table.row(tr).data();
                    var id_monper   = datatable[18];
                    var tahun       = datatable[19];
                    var id_role     = datatable[20];
                    var id_relation = datatable[21];
                    swal({
                    title: titleDel,
                    text: messDel,
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: buttDel
                }).then(function () {
                	$.ajax({
    					type: "DELETE",
                        url: urls+'problem-identification/delete/'+id+'/'+id_relation,
                        beforeSend : function(xhr){
                        	xhr.setRequestHeader(header,token);
                        },
                        success: function (result) {
                        	swal(titleOk,messOk,'success');
                                grid();
                        },
                        error:function (result) {
                        	swal(titleOk,messNOk,'error');
                        },
                    })
                }, function (dismiss) {
                    if (dismiss === 'cancel') {
                    }
                })
             });
             
             function clearForm(){
				$('#id').val("").removeAttr("readonly");
                                $('#id_relation').val("").removeAttr("readonly");
				$('#ref_category').val("").removeAttr("readonly");
				$('#problem').val("").removeAttr("readonly");
				$('#follow_up').val("").removeAttr("readonly");
                                $('#filter_sdg').val("").removeAttr("readonly");
                                $('#submit').removeAttr("Disabled");
                                $2('#filter_sdg').jstree(true).uncheck_all();
				$('.control-group').removeClass('error');
				$('.help-block').text("");
			}
			
			$('#myModal').on('hidden.bs.modal',function(){
				clearForm();
			});
        $('#submit').on('click', function(){
            var id              = $('#id').val();
            var id_relation     = $('#id_relation').val();
            var id_cat          = $('#ref_category').val();
            var v_dataid        = $("#periode").val();
            var v_data_id       = v_dataid.split("###");;
            var id_monper       = v_data_id[0];
            var tahun           = v_data_id[1];
            var v_idrole        = $("#idrole").val();
            var id_prov         = $("#id_prov").val();
            var problem         = $('#problem').val();
            var follow_up       = $('#follow_up').val();
            var sdgs_group      = $('#filter_sdg').val();
            var data_sdgs_map   = $2('#filter_sdg').jstree(true).get_checked();
            if(data_sdgs_map.length>0){
                    var sdgs_map =[];
                    $.each(data_sdgs_map,function(i,x){
                        var id_goals,id_target,id_indicator ="";
                        var split_length = (x.split('.').length-1);
                        var split        =  x.split('.');
                        if(split_length==0){
                            id_goals = x;
                            id_target       = "";
                            id_indicator    = "";

                        }
                        if(split_length==1){

                            id_goals     = split[0];
                            id_target    = split[1];
                            id_indicator    = "";
                        }
                        if(split_length==2){

                            id_goals        = split[0];
                            id_target       = split[1];
                            id_indicator    = split[2];
                        }
                        sdgs_map.push({
                                        'id_prov'       :id_prov,
                                        'id_monper'     :id_monper,
                                        'id_goals'      :id_goals,
                                        'id_target'     :id_target,
                                        'id_indicator'  :id_indicator
                                        ,'id_sdgs'      :x
                                    });
                
                    });
           
                    var sdgs_group_split = sdgs_group.split(".");
                    var id_goals         = sdgs_group_split[0];
                    var id_target        = sdgs_group_split[1];
                    var id_indicator     = sdgs_group_split[2];

                    $('.control-group').removeClass('error');
                    $('.help-block').text("");

                    var data = JSON.stringify({
                                    'id'            :id,
                                    'id_cat'        :id_cat,
                                    'id_goals'      :id_goals,
                                    'id_target'     :id_target,
                                    'id_indicator'  :id_indicator,
                                    'problem'       :problem,
                                    'follow_up'     :follow_up,
                                    'id_monper'     :id_monper,
                                    'id_role'       :v_idrole,
                                    'id_prov'       :id_prov,
                                    'tahun'         :tahun,
                                    'id_relation'   :id_relation,
                                    'sdgs_map'      :sdgs_map
                                });
                            $.ajax({
                                    type: "POST",
                                    url: urls+'problem-identification/save',
                                    beforeSend : function(xhr){
                                        xhr.setRequestHeader(header,token);
                                    },
                                    headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                        data: data,
                                    success: function (result) {
                                       grid();// table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole).load();
                                        $('#myModal').modal('hide');
                                    },
                                });
            }else{
//                swal("Peringatan","SDG Belum Tercentang",'error');
            }
            
        });
        
//       $2(document).ready(function(){
//          alert("hallo"); 
//       });
//       
    </script>
</body>
<style>
    .select2-container--open {
        z-index: 9999999
    }
    /* table{
        margin: 0 auto;
        width: 100%;
        clear: both;
        border-collapse: collapse;
        table-layout: fixed; 
        word-wrap:keep-all; 
      } */
</style>

</html>